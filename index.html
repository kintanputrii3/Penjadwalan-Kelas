<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Info D</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Memuat Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Lobster&display=swap" rel="stylesheet">
    
    <!-- CSS Kustom (Sama seperti sebelumnya) -->
    <style>
        /* * Tema Igari Mori
         * Palette:
         * Cream: #F7F3E8
         * Green: #7A9B76
         * Red: #D96060
         * Yellow: #F0D064
         * Dark Text: #4E413B
        */
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F7F3E8; /* Cream */
            color: #4E413B;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Lobster', cursive;
        }

        /* Latar Belakang Stroberi */
        .strawberry-wallpaper {
            background-color: #fce4e4;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='20' viewBox='0 0 16 20'%3E%3Cpath d='M8 1C5 1 2 3 0 6c-2 3-1 7 0 10 1 3 4 4 8 4s7-1 8-4c1-3 2-7 0-10C14 3 11 1 8 1z' fill='%23D96060' fill-opacity='0.7'/%3E%3Cpath d='M6 1C7 2 7 3 6 3s-1-1-1-1zm4 0c-1 1-1 2 0 2s1-1 1-1z' fill='%237A9B76' fill-opacity='0.7'/%3E%3C/svg%3E");
            background-size: 24px 24px;
            background-repeat: repeat;
        }
        .bg-theme-cream { background-color: #F7F3E8; }
        .bg-theme-green { background-color: #7A9B76; }
        .btn-theme-green { background-color: #7A9B76; color: white; }
        .btn-theme-green:hover { background-color: #5d7c5a; }
        .bg-theme-red { background-color: #D96060; }
        .btn-theme-red { background-color: #D96060; color: white; }
        .btn-theme-red:hover { background-color: #b54a4a; }
        .bg-theme-yellow { background-color: #F0D064; }
        .text-theme-dark { color: #4E413B; }
        .text-theme-red { color: #D96060; }
        .text-theme-green { color: #7A9B76; }
        .border-theme-green { border-color: #7A9B76; }
        .border-theme-red { border-color: #D96060; }
        .btn { @apply py-2 px-4 rounded-lg shadow-md font-semibold transition-all duration-200 transform hover:scale-105; }
        .tab-btn { @apply py-2 px-4 font-semibold rounded-t-lg cursor-pointer; }
        .tab-btn.active { @apply text-white; }
        .tab-content { @apply p-4 bg-white rounded-b-lg rounded-tr-lg shadow-inner; }
        .ribbon-header { @apply text-2xl font-bold text-white py-2 px-6 shadow-lg relative; background-color: #D96060; border-radius: 8px 8px 0 0; margin-bottom: 10px; }
        .ribbon-header::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 0; height: 0; border-style: solid; border-width: 0 0 10px 10px; border-color: transparent transparent #a34747 transparent; }
    </style>
</head>
<body class="bg-theme-cream min-h-screen">

    <!-- Indikator Loading Global -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
        <div class="text-white text-2xl font-bold animate-pulse">Memuat...</div>
    </div>

    <!-- Kontainer Utama Aplikasi -->
    <div id="app" class="container mx-auto p-4 max-w-4xl">

        <!-- 1. HALAMAN LOGIN -->
        <div id="login-screen" class="strawberry-wallpaper p-6 md:p-10 rounded-2xl shadow-2xl border-4 border-white">
            <div class="bg-white/90 p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                
                <div class="flex justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-green"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>

                <h1 class="text-4xl text-center text-theme-red mb-4">üçì Class Info D üçì</h1>
                <p class="text-center text-theme-dark mb-6">Silakan login untuk melanjutkan</p>
                
                <!-- Tab Admin/User (Hanya visual, login form sama) -->
                <div class="flex mb-4 border-b-2" id="login-tab-container">
                    <button data-target="user" class="login-tab tab-btn active flex-1 text-lg" style="background-color: #7A9B76;">Siswa</button>
                    <button data-target="admin" class="login-tab tab-btn flex-1 text-lg" style="background-color: #D96060; opacity: 0.7;">Admin</button>
                </div>

                <!-- Form Login -->
                <form id="login-form">
                    <div class="mb-4">
                        <!-- DIUBAH: Label dari Username menjadi Email -->
                        <label for="email" class="block text-sm font-semibold mb-2">Email:</label>
                        <input type="email" id="email" class="w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-semibold mb-2">Password:</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2" required>
                    </div>
                    
                    <button type="submit" id="login-button" class="btn w-full btn-theme-green text-lg">
                        Login
                    </button>
                    
                    <p id="login-error" class="text-red-600 text-center mt-4"></p>
                </form>
            </div>
        </div>

        <!-- 2. DASHBOARD USER -->
        <div id="user-dashboard" class="hidden">
            <header class="flex justify-between items-center mb-6 p-4 bg-theme-green text-white rounded-lg shadow-md">
                <h1 class="text-3xl" id="welcome-user"></h1>
                <button id="user-logout-btn" class="btn bg-theme-red hover:bg-red-700">Logout</button>
            </header>

            <div class="mb-4 flex">
                <button data-target="user-tab-pelajaran" class="tab-btn user-tab active bg-theme-green">üìö Jadwal Pelajaran</button>
                <button data-target="user-tab-piket" class="tab-btn user-tab bg-gray-300 text-gray-700">üßπ Jadwal Piket</button>
                <button data-target="user-tab-notifikasi" class="tab-btn user-tab bg-gray-300 text-gray-700">üîî Notifikasi</button>
            </div>

            <div id="user-tab-pelajaran" class="tab-content user-tab-content">
                <h2 class="ribbon-header">Jadwal Pelajaran</h2>
                <div id="user-jadwal-pelajaran-container" class="space-y-4"></div>
            </div>
            <div id="user-tab-piket" class="tab-content user-tab-content hidden">
                <h2 class="ribbon-header" style="background-color: #7A9B76;">Jadwal Piket Saya</h2>
                <div id="user-jadwal-piket-container"></div>
            </div>
            <div id="user-tab-notifikasi" class="tab-content user-tab-content hidden">
                <h2 class="ribbon-header" style="background-color: #F0D064;">Notifikasi</h2>
                <div id="user-notifikasi-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- 3. DASHBOARD ADMIN -->
        <div id="admin-dashboard" class="hidden">
            <header class="flex justify-between items-center mb-6 p-4 bg-theme-red text-white rounded-lg shadow-md">
                <h1 class="text-3xl" id="welcome-admin">Welcome, Admin!</h1>
                <button id="admin-logout-btn" class="btn bg-gray-800 hover:bg-gray-900">Logout</button>
            </header>

            <div class="mb-4 flex">
                <button data-target="admin-tab-pelajaran" class="tab-btn admin-tab active bg-theme-red">Kelola Jadwal Pelajaran</button>
                <button data-target="admin-tab-piket" class="tab-btn admin-tab bg-gray-300 text-gray-700">Kelola Jadwal Piket</button>
                <button data-target="admin-tab-notifikasi" class="tab-btn admin-tab bg-gray-300 text-gray-700">Kelola Notifikasi</button>
            </div>
            
            <!-- Kelola Jadwal Pelajaran -->
            <div id="admin-tab-pelajaran" class="tab-content admin-tab-content">
                <h2 class="ribbon-header">Kelola Jadwal Pelajaran üìö</h2>
                <form id="form-edit-pelajaran" class="mb-6 p-4 bg-theme-cream rounded-lg shadow-sm border border-theme-red">
                    <h3 class="text-xl font-semibold mb-3 text-theme-red">Tambah / Edit Pelajaran</h3>
                    <input type="hidden" id="pelajaran-edit-id">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <select id="pelajaran-hari" class="w-full p-2 border rounded-lg">
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                        </select>
                        <input type="text" id="pelajaran-waktu" placeholder="cth: 07.15-09.30" class="w-full p-2 border rounded-lg">
                        <input type="text" id="pelajaran-mapel" placeholder="Mata Pelajaran" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="mt-3 flex gap-2">
                        <button type="submit" class="btn btn-theme-green">Simpan</button>
                        <button type="button" id="batal-edit-pelajaran" class="btn bg-gray-400 hover:bg-gray-500">Batal</button>
                    </div>
                </form>
                <div id="admin-jadwal-pelajaran-container" class="space-y-4"></div>
            </div>

            <!-- Kelola Jadwal Piket -->
            <div id="admin-tab-piket" class="tab-content admin-tab-content hidden">
                <h2 class="ribbon-header" style="background-color: #7A9B76;">Kelola Jadwal Piket üßπ</h2>
                <form id="form-edit-piket" class="mb-6 p-4 bg-theme-cream rounded-lg shadow-sm border border-theme-green">
                    <h3 class="text-xl font-semibold mb-3 text-theme-green">Tambah Siswa Piket</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <select id="piket-hari" class="w-full p-2 border rounded-lg">
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                        </select>
                        <input type="text" id="piket-nama" placeholder="Nama Siswa (harus sama dengan username)" class="w-full p-2 border rounded-lg">
                    </div>
                    <button type="submit" class="btn btn-theme-green mt-3">Tambah Siswa</button>
                </form>
                <div id="admin-jadwal-piket-container" class="space-y-4"></div>
            </div>

            <!-- Kelola Notifikasi -->
            <div id="admin-tab-notifikasi" class="tab-content admin-tab-content hidden">
                <h2 class="ribbon-header" style="background-color: #F0D064;">Kelola Notifikasi üîî</h2>
                <form id="form-kirim-notifikasi" class="mb-6 p-4 bg-theme-cream rounded-lg shadow-sm border border-theme-yellow">
                    <h3 class="text-xl font-semibold mb-3 text-theme-dark">Kirim Notifikasi Baru</h3>
                    <div class="mb-3">
                        <label for="notifikasi-target" class="block text-sm font-semibold mb-1">Kirim ke:</label>
                        <select id="notifikasi-target" class="w-full p-2 border rounded-lg">
                            <option value="all">Semua Siswa</option>
                            <!-- Daftar siswa akan ditambahkan oleh JS -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notifikasi-pesan" class="block text-sm font-semibold mb-1">Pesan:</label>
                        <textarea id="notifikasi-pesan" rows="3" class="w-full p-2 border rounded-lg" placeholder="Tulis pesan notifikasi..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-theme-green">Kirim Notifikasi</button>
                </form>
                <h3 class="text-xl font-semibold mb-3 text-theme-dark">Daftar Notifikasi Terkirim:</h3>
                <div id="admin-notifikasi-container" class="space-y-3"></div>
            </div>
        </div>

    </div>

    <!-- JavaScript Aplikasi -->
    <script type="module">
        // --- KONEKSI SUPABASE ---
        // GANTI DENGAN URL DAN KUNCI ANON DARI PROYEK SUPABASE ANDA (DARI LANGKAH 2 PANDUAN)
        const SUPABASE_URL = 'https://URL_PROYEK_ANDA.supabase.co';
        const SUPABASE_KEY = 'KUNCI_ANON_PUBLIK_ANDA';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Cek koneksi (opsional)
        if (!db) {
            console.error("Koneksi Supabase gagal. Periksa URL dan Kunci.");
            alert("Koneksi ke database gagal!");
        }

        // Objek state aplikasi
        let appState = {
            currentUser: null, // { session: Session, profile: {id, username, role} }
            currentView: 'login', // 'login', 'user', 'admin'
            editingPelajaranId: null
        };

        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Fungsi Helper Loading ---
        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { loadingIndicator.classList.add('hidden'); }

        
        // --- Fungsi Render Tampilan ---
        async function renderApp() {
            const loginScreen = document.getElementById('login-screen');
            const userDashboard = document.getElementById('user-dashboard');
            const adminDashboard = document.getElementById('admin-dashboard');

            loginScreen.classList.add('hidden');
            userDashboard.classList.add('hidden');
            adminDashboard.classList.add('hidden');

            if (appState.currentView === 'login') {
                loginScreen.classList.remove('hidden');
                document.getElementById('login-error').textContent = '';
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                document.querySelector('.login-tab[data-target="user"]').click();
            } else if (appState.currentView === 'user') {
                userDashboard.classList.remove('hidden');
                await renderUserDashboard();
            } else if (appState.currentView === 'admin') {
                adminDashboard.classList.remove('hidden');
                await renderAdminDashboard();
            }
        }

        // --- Fungsi Render Dashboard User ---
        async function renderUserDashboard() {
            document.getElementById('welcome-user').textContent = `Hi, ${appState.currentUser.profile.username}! üå∏`;
            showLoading();
            await Promise.all([
                renderUserJadwalPelajaran(),
                renderUserJadwalPiket(),
                renderUserNotifikasi()
            ]);
            hideLoading();
            switchUserTab('user-tab-pelajaran');
        }

        async function renderUserJadwalPelajaran() {
            const container = document.getElementById('user-jadwal-pelajaran-container');
            container.innerHTML = '';
            
            const { data, error } = await db.from('jadwal_pelajaran').select('*').order('waktu');
            if (error) { console.error(error); return; }

            // Kelompokkan berdasarkan hari
            const scheduleByDay = data.reduce((acc, item) => {
                if (!acc[item.hari]) acc[item.hari] = [];
                acc[item.hari].push(item);
                return acc;
            }, {});

            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
            days.forEach(day => {
                const daySchedule = scheduleByDay[day] || [];
                let dayHtml = `
                    <div class="p-4 rounded-lg shadow-md bg-white border-l-4 border-theme-green">
                        <h3 class="text-2xl font-semibold text-theme-green mb-3">${day} üçé</h3>
                        <ul class="space-y-2">
                `;
                if (daySchedule.length > 0) {
                    daySchedule.forEach(item => {
                        dayHtml += `
                            <li class="flex justify-between items-center">
                                <span class="font-semibold text-theme-dark">${item.mapel}</span>
                                <span class="text-sm bg-theme-cream px-2 py-1 rounded">${item.waktu}</span>
                            </li>
                        `;
                    });
                } else {
                    dayHtml += `<li class="text-gray-500">Tidak ada jadwal</li>`;
                }
                dayHtml += `</ul></div>`;
                container.innerHTML += dayHtml;
            });
        }

        async function renderUserJadwalPiket() {
            const container = document.getElementById('user-jadwal-piket-container');
            container.innerHTML = '';
            const userName = appState.currentUser.profile.username;
            
            const { data, error } = await db.from('jadwal_piket').select('*');
            if (error) { console.error(error); return; }

            // Kelompokkan berdasarkan hari
            const piketByDay = data.reduce((acc, item) => {
                if (!acc[item.hari]) acc[item.hari] = [];
                acc[item.hari].push(item.nama);
                return acc;
            }, {});

            let myDay = null;
            for (const day in piketByDay) {
                if (piketByDay[day].includes(userName)) {
                    myDay = day;
                    break;
                }
            }
            
            if (myDay) {
                const team = piketByDay[myDay];
                let teamHtml = `<ul class="space-y-2">`;
                team.forEach(name => {
                    teamHtml += `
                        <li class="p-2 rounded ${name === userName ? 'bg-theme-yellow font-bold' : 'bg-gray-100'}">
                            ${name} ${name === userName ? '(Anda)' : ''}
                        </li>
                    `;
                });
                teamHtml += `</ul>`;
                container.innerHTML = `
                    <h3 class="text-xl font-semibold mb-3">Anda piket hari: <span class="text-theme-red">${myDay}</span></h3>
                    <p class="mb-4">Bersama dengan:</p>
                    ${teamHtml}
                `;
            } else {
                container.innerHTML = `<p class="text-gray-600 text-center p-4">Anda tidak terdaftar di jadwal piket. üåº</p>`;
            }
        }

        async function renderUserNotifikasi() {
            const container = document.getElementById('user-notifikasi-container');
            container.innerHTML = '';
            const userName = appState.currentUser.profile.username;
            
            const { data, error } = await db.from('notifikasi')
                .select('*')
                .or(`target.eq.all,target.eq.${userName}`)
                .order('created_at', { ascending: false });

            if (error) { console.error(error); return; }
            
            if (data && data.length > 0) {
                data.forEach(notif => {
                    container.innerHTML += `
                        <div class="p-3 bg-blue-100 border-l-4 border-blue-500 rounded-lg">
                            <p class="font-semibold ${notif.target === 'all' ? 'text-blue-800' : 'text-purple-800'}">
                                ${notif.target === 'all' ? 'Info (Umum)' : 'Info (Pribadi)'}
                            </p>
                            <p class="text-gray-800">${notif.message}</p>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `<p class="text-gray-600 text-center p-4">Tidak ada notifikasi baru. üçÉ</p>`;
            }
        }

        // --- Fungsi Render Dashboard Admin ---
        async function renderAdminDashboard() {
            showLoading();
            await Promise.all([
                renderAdminJadwalPelajaran(),
                renderAdminJadwalPiket(),
                renderAdminNotifikasi(),
                populateUserDropdown()
            ]);
            hideLoading();
            switchAdminTab('admin-tab-pelajaran');
        }

        async function renderAdminJadwalPelajaran() {
            const container = document.getElementById('admin-jadwal-pelajaran-container');
            container.innerHTML = '';
            
            const { data, error } = await db.from('jadwal_pelajaran').select('*').order('waktu');
            if (error) { console.error(error); return; }

            const scheduleByDay = data.reduce((acc, item) => {
                if (!acc[item.hari]) acc[item.hari] = [];
                acc[item.hari].push(item);
                return acc;
            }, {});

            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
            days.forEach(day => {
                const daySchedule = scheduleByDay[day] || [];
                let dayHtml = `
                    <div class="p-4 rounded-lg shadow-md bg-white border-l-4 border-theme-red">
                        <h3 class="text-2xl font-semibold text-theme-red mb-3">${day}</h3>
                        <ul class="space-y-2">
                `;
                daySchedule.forEach(item => {
                    dayHtml += `
                        <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <div>
                                <span class="font-semibold text-theme-dark">${item.mapel}</span>
                                <span class="text-sm text-gray-600 ml-2">(${item.waktu})</span>
                            </div>
                            <div class="space-x-2">
                                <button class="edit-pelajaran-btn btn btn-theme-green btn-sm py-1 px-2 text-sm" data-id="${item.id}" data-hari="${item.hari}" data-waktu="${item.waktu}" data-mapel="${item.mapel}">Edit</button>
                                <button class="delete-pelajaran-btn btn btn-theme-red btn-sm py-1 px-2 text-sm" data-id="${item.id}">Hapus</button>
                            </div>
                        </li>
                    `;
                });
                dayHtml += `</ul></div>`;
                container.innerHTML += dayHtml;
            });
            
            container.querySelectorAll('.edit-pelajaran-btn').forEach(btn => btn.addEventListener('click', handleEditPelajaran));
            container.querySelectorAll('.delete-pelajaran-btn').forEach(btn => btn.addEventListener('click', handleDeletePelajaran));
        }

        async function renderAdminJadwalPiket() {
            const container = document.getElementById('admin-jadwal-piket-container');
            container.innerHTML = '';

            const { data, error } = await db.from('jadwal_piket').select('*');
            if (error) { console.error(error); return; }

            const piketByDay = data.reduce((acc, item) => {
                if (!acc[item.hari]) acc[item.hari] = [];
                acc[item.hari].push(item);
                return acc;
            }, {});

            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
            days.forEach(day => {
                const dayPiket = piketByDay[day] || [];
                let dayHtml = `
                    <div class="p-4 rounded-lg shadow-md bg-white border-l-4 border-theme-green">
                        <h3 class="text-2xl font-semibold text-theme-green mb-3">${day}</h3>
                        <ul class="flex flex-wrap gap-2">
                `;
                dayPiket.forEach(item => {
                    dayHtml += `
                        <li class="flex items-center bg-theme-cream px-3 py-1 rounded-full shadow-sm">
                            <span class="font-semibold">${item.nama}</span>
                            <button class="delete-piket-btn text-red-600 font-bold ml-2" data-id="${item.id}">√ó</button>
                        </li>
                    `;
                });
                dayHtml += `</ul></div>`;
                container.innerHTML += dayHtml;
            });
            
            container.querySelectorAll('.delete-piket-btn').forEach(btn => btn.addEventListener('click', handleDeletePiket));
        }
        
        async function renderAdminNotifikasi() {
            const container = document.getElementById('admin-notifikasi-container');
            container.innerHTML = '';
            
            const { data, error } = await db.from('notifikasi').select('*').order('created_at', { ascending: false });
            if (error) { console.error(error); return; }

            data.forEach(notif => {
                container.innerHTML += `
                    <div class="p-3 bg-gray-100 rounded-lg shadow-sm flex justify-between items-start">
                        <div>
                            <span class="text-sm font-semibold rounded-full px-2 py-0.5 ${notif.target === 'all' ? 'bg-blue-200 text-blue-800' : 'bg-purple-200 text-purple-800'}">
                                ${notif.target === 'all' ? 'Semua' : notif.target}
                            </span>
                            <p class="text-gray-800 mt-1">${notif.message}</p>
                        </div>
                        <button class="delete-notifikasi-btn text-red-600 font-bold p-1" data-id="${notif.id}">√ó</button>
                    </div>
                `;
            });
            
            container.querySelectorAll('.delete-notifikasi-btn').forEach(btn => btn.addEventListener('click', handleDeleteNotifikasi));
        }
        
        async function populateUserDropdown() {
            const select = document.getElementById('notifikasi-target');
            Array.from(select.options).forEach(option => {
                if (option.value !== 'all') option.remove();
            });
            
            const { data, error } = await db.from('profiles').select('username').eq('role', 'user');
            if (error) { console.error(error); return; }

            data.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.username;
                option.textContent = profile.username;
                select.appendChild(option);
            });
        }

        // --- Fungsi Aksi & Event Handler ---

        // Handler Login
        async function handleLogin(e) {
            e.preventDefault();
            showLoading();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            const { data, error } = await db.auth.signInWithPassword({
                email: email,
                password: pass,
            });
            
            if (error) {
                document.getElementById('login-error').textContent = 'Email atau password salah!';
                console.error('Login error:', error.message);
            } else {
                // onAuthStateChange akan menangani sisanya
                document.getElementById('login-error').textContent = '';
            }
            hideLoading();
        }

        // Handler Logout
        async function handleLogout() {
            showLoading();
            await db.auth.signOut();
            appState.currentUser = null;
            appState.currentView = 'login';
            await renderApp();
            hideLoading();
        }

        // Handler Tab
        function switchTab(e, tabClass, contentClass, activeBg) {
            const targetId = e.target.dataset.target;
            document.querySelectorAll(`.${tabClass}`).forEach(tab => {
                tab.classList.remove('active', activeBg);
                tab.classList.add('bg-gray-300', 'text-gray-700');
            });
            e.target.classList.add('active', activeBg);
            e.target.classList.remove('bg-gray-300', 'text-gray-700');
            document.querySelectorAll(`.${contentClass}`).forEach(content => content.classList.add('hidden'));
            document.getElementById(targetId).classList.remove('hidden');
        }

        function switchUserTab(targetId) {
            document.querySelectorAll('.user-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.target === targetId);
                tab.classList.toggle('bg-theme-green', tab.dataset.target === targetId);
                tab.classList.toggle('bg-gray-300', tab.dataset.target !== targetId);
                tab.classList.toggle('text-gray-700', tab.dataset.target !== targetId);
            });
            document.querySelectorAll('.user-tab-content').forEach(content => content.classList.toggle('hidden', content.id !== targetId));
        }
        
        function switchAdminTab(targetId) {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.target === targetId);
                tab.classList.toggle('bg-theme-red', tab.dataset.target === targetId);
                tab.classList.toggle('bg-gray-300', tab.dataset.target !== targetId);
                tab.classList.toggle('text-gray-700', tab.dataset.target !== targetId);
            });
            document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.toggle('hidden', content.id !== targetId));
        }
        
        document.querySelectorAll('.login-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const target = e.target.dataset.target;
                const userTab = document.querySelector('.login-tab[data-target="user"]');
                const adminTab = document.querySelector('.login-tab[data-target="admin"]');
                const loginBtn = document.getElementById('login-button');
                const emailInput = document.getElementById('email');

                if (target === 'user') {
                    userTab.style.backgroundColor = '#7A9B76'; userTab.style.opacity = 1;
                    adminTab.style.backgroundColor = '#D96060'; adminTab.style.opacity = 0.7;
                    loginBtn.classList.remove('btn-theme-red'); loginBtn.classList.add('btn-theme-green');
                    emailInput.placeholder = "cth: user@kelasd.com";
                } else {
                    userTab.style.backgroundColor = '#7A9B76'; userTab.style.opacity = 0.7;
                    adminTab.style.backgroundColor = '#D96060'; adminTab.style.opacity = 1;
                    loginBtn.classList.remove('btn-theme-green'); loginBtn.classList.add('btn-theme-red');
                    emailInput.placeholder = "cth: admin@kelasd.com";
                }
            });
        });

        // --- Handler Admin: Kelola Pelajaran ---
        async function handleFormPelajaran(e) {
            e.preventDefault();
            showLoading();
            const id = appState.editingPelajaranId;
            const payload = {
                hari: document.getElementById('pelajaran-hari').value,
                waktu: document.getElementById('pelajaran-waktu').value,
                mapel: document.getElementById('pelajaran-mapel').value
            };
            
            if (!payload.waktu || !payload.mapel) {
                alert("Waktu dan Mata Pelajaran harus diisi!");
                hideLoading(); return;
            }
            
            let error;
            if (id) {
                ({ error } = await db.from('jadwal_pelajaran').update(payload).eq('id', id));
            } else {
                ({ error } = await db.from('jadwal_pelajaran').insert(payload));
            }
            
            if (error) console.error(error);
            await renderAdminJadwalPelajaran();
            resetFormPelajaran();
            hideLoading();
        }

        function handleEditPelajaran(e) {
            const btn = e.target;
            appState.editingPelajaranId = btn.dataset.id;
            document.getElementById('pelajaran-edit-id').value = btn.dataset.id;
            document.getElementById('pelajaran-hari').value = btn.dataset.hari;
            document.getElementById('pelajaran-waktu').value = btn.dataset.waktu;
            document.getElementById('pelajaran-mapel').value = btn.dataset.mapel;
        }

        async function handleDeletePelajaran(e) {
            showLoading();
            const id = e.target.dataset.id;
            await db.from('jadwal_pelajaran').delete().eq('id', id);
            await renderAdminJadwalPelajaran();
            hideLoading();
        }
        
        function resetFormPelajaran() {
            appState.editingPelajaranId = null;
            document.getElementById('form-edit-pelajaran').reset();
            document.getElementById('pelajaran-edit-id').value = '';
        }

        // --- Handler Admin: Kelola Piket ---
        async function handleFormPiket(e) {
            e.preventDefault();
            showLoading();
            const payload = {
                hari: document.getElementById('piket-hari').value,
                nama: document.getElementById('piket-nama').value
            };
            
            if (!payload.nama) { hideLoading(); return; }
            
            const { error }_ = await db.from('jadwal_piket').insert(payload);
            if (error) console.error(error);

            await renderAdminJadwalPiket();
            document.getElementById('piket-nama').value = '';
            hideLoading();
        }

        async function handleDeletePiket(e) {
            showLoading();
            const id = e.target.dataset.id;
            await db.from('jadwal_piket').delete().eq('id', id);
            await renderAdminJadwalPiket();
            hideLoading();
        }

        // --- Handler Admin: Kelola Notifikasi ---
        async function handleFormNotifikasi(e) {
            e.preventDefault();
            showLoading();
            const payload = {
                target: document.getElementById('notifikasi-target').value,
                message: document.getElementById('notifikasi-pesan').value
            };
            
            if (!payload.message) { hideLoading(); return; }
            
            await db.from('notifikasi').insert(payload);
            await renderAdminNotifikasi();
            document.getElementById('notifikasi-pesan').value = '';
            hideLoading();
        }
        
        async function handleDeleteNotifikasi(e) {
            showLoading();
            const id = e.target.dataset.id;
            await db.from('notifikasi').delete().eq('id', id);
            await renderAdminNotifikasi();
            hideLoading();
        }

        // --- Inisialisasi Aplikasi ---
        async function initializeApp() {
            // Listener status otentikasi
            db.auth.onAuthStateChange(async (event, session) => {
                showLoading();
                if (session) {
                    // Pengguna berhasil login
                    const { data: profile, error } = await db.from('profiles')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (profile) {
                        appState.currentUser = { session, profile };
                        appState.currentView = profile.role;
                    } else {
                        // Seharusnya tidak terjadi jika trigger disetup
                        console.error("Profile tidak ditemukan!");
                        await db.auth.signOut();
                        appState.currentView = 'login';
                    }
                } else {
                    // Pengguna logout
                    appState.currentUser = null;
                    appState.currentView = 'login';
                }
                await renderApp();
                hideLoading();
            });

            // Cek sesi yang ada saat load
            const { data: { session } } = await db.auth.getSession();
            if (!session) {
                // Jika tidak ada sesi, tampilkan login
                appState.currentView = 'login';
                await renderApp();
            }
            // Jika ADA sesi, onAuthStateChange akan otomatis terpicu dan menangani render
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners Global
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('user-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);

            document.querySelectorAll('.user-tab').forEach(tab => tab.addEventListener('click', (e) => switchTab(e, 'user-tab', 'user-tab-content', 'bg-theme-green')));
            document.querySelectorAll('.admin-tab').forEach(tab => tab.addEventListener('click', (e) => switchTab(e, 'admin-tab', 'admin-tab-content', 'bg-theme-red')));
            
            document.getElementById('form-edit-pelajaran').addEventListener('submit', handleFormPelajaran);
            document.getElementById('batal-edit-pelajaran').addEventListener('click', resetFormPelajaran);
            document.getElementById('form-edit-piket').addEventListener('submit', handleFormPiket);
            document.getElementById('form-kirim-notifikasi').addEventListener('submit', handleFormNotifikasi);
            
            initializeApp();
        });
    </script>
</body>
</html>
